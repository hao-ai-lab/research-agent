name: Bot PR Feedback Loop

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

# Keep one active worker per PR.
concurrency:
  group: bot-feedback-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  handle-feedback:
    if: >
      github.event.comment.user.type != 'Bot' &&
      startsWith(github.event.comment.body, '/bot') &&
      (
        github.event_name == 'pull_request_review_comment' ||
        github.event.issue.pull_request != null
      )
    runs-on: ubuntu-latest
    timeout-minutes: 35
    permissions:
      issues: write
      pull-requests: write
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || github.token }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install modal httpx

      - name: Resolve PR number and persist feedback prompt
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            PR_NUMBER="${{ github.event.issue.number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          echo "PR_NUMBER=${PR_NUMBER}" >> "$GITHUB_ENV"

          cat > /tmp/bot_feedback.txt << 'BOT_FEEDBACK_EOF'
          ${{ github.event.comment.body }}
          BOT_FEEDBACK_EOF

      - name: Mark comment as picked up
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = context.payload.comment.id
            if (context.eventName === 'issue_comment') {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                content: 'eyes',
              })
              return
            }
            await github.rest.reactions.createForPullRequestReviewComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              content: 'eyes',
            })

      - name: Run follow-up solver on PR branch
        id: followup
        continue-on-error: true
        run: |
          python agent_solver.py \
            --mode followup-pr \
            --pr-number "${PR_NUMBER}" \
            --feedback-file /tmp/bot_feedback.txt \
            --repo "${{ github.repository }}" \
            --output-file /tmp/followup_result.json
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
          GH_PAT: ${{ secrets.GH_PAT }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          RESEARCH_AGENT_KEY: ${{ secrets.RESEARCH_AGENT_KEY }}

      - name: Post follow-up status to PR
        if: always()
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ env.PR_NUMBER }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        with:
          script: |
            const fs = require('fs')
            const prNumber = Number(process.env.PR_NUMBER)
            const outcome = '${{ steps.followup.outcome }}'
            const promptRaw = String(process.env.COMMENT_BODY || '').trim()
            let parsed = {}
            try {
              if (fs.existsSync('/tmp/followup_result.json')) {
                parsed = JSON.parse(fs.readFileSync('/tmp/followup_result.json', 'utf8'))
              }
            } catch (err) {
              parsed = { parse_error: String(err) }
            }

            const noChanges = Boolean(parsed.no_changes)
            const logTail = String(parsed.agent_output_tail || '').trim()
            const diffStat = String(parsed.diff_stat || '').trim()
            let body

            if (outcome === 'success') {
              body = [
                'ðŸ¤– **Bot Feedback Run Completed**',
                '',
                `Processed command from @${context.payload.comment.user.login}:`,
                '',
                '```text',
                promptRaw.slice(0, 1600),
                '```',
                '',
                noChanges
                  ? 'No code changes were needed for this feedback.'
                  : 'Changes were pushed to this PR branch.',
                diffStat ? `\n### Diff stat\n\`\`\`\n${diffStat}\n\`\`\`` : '',
                logTail ? `\n### Operations tail\n\`\`\`\n${logTail.slice(-1800)}\n\`\`\`` : '',
              ].join('\n')
            } else {
              const errText = parsed.error || 'The bot failed while processing this command.'
              body = [
                'âŒ **Bot Feedback Run Failed**',
                '',
                `Command from @${context.payload.comment.user.login}:`,
                '',
                '```text',
                promptRaw.slice(0, 1200),
                '```',
                '',
                `${errText}`,
                '',
                `Check [Actions logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions).`,
                logTail ? `\n### Operations tail\n\`\`\`\n${logTail.slice(-1800)}\n\`\`\`` : '',
              ].join('\n')
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            })
